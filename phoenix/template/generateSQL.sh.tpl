#!/bin/bash

if [ $# -lt 1 ]; then
  echo "USAGE:" $0 "filename.sql"
  exit
fi

# how much node the table will have
maxid1=MAXID1_PLACEHOLDER

# how much region you want it to be presplited.
presplitNum=20

# count table use half number of the presplit region
countsplitNum=$[$presplitNum/2]

sqlfile=$1

# begin to generate sql

splitNum=$presplitNum
step=$[$maxid1/$splitNum]
tablesplit="SPLIT ON ("$[$step]"L"

for (( i = 2; i < splitNum; i++))
do
  splitpos=$[$step*$i]"L"
  tablesplit=$tablesplit", "$splitpos
done
tablesplit=$tablesplit");"

echo "-- Auto Generated by $0 --" > $sqlfile

echo "
CREATE TABLE linktable (
    id1 BIGINT NOT NULL,
    id2 BIGINT NOT NULL,
    link_type BIGINT NOT NULL,
    visibility INTEGER NOT NULL,
    data VARBINARY(255) NOT NULL,
    time BIGINT NOT NULL,
    version INTEGER NOT NULL
    CONSTRAINT pk PRIMARY KEY (id1, id2, link_type)
    )
    COMPRESSION='LZO'" >> $sqlfile
echo "    "$tablesplit >> $sqlfile

echo "
CREATE TABLE nodetable (
    id BIGINT NOT NULL PRIMARY KEY,
    type INTEGER NOT NULL,
    version BIGINT NOT NULL,
    time INTEGER NOT NULL,
    data VARBINARY NOT NULL
    )
    COMPRESSION='LZO'" >> $sqlfile
echo "    "$tablesplit >> $sqlfile

# for count table

splitNum=$countsplitNum
step=$[$maxid1/$splitNum]
tablesplit="SPLIT ON ("$[$step]"L"

for (( i = 2; i < splitNum; i++))
do
  splitpos=$[$step*$i]"L"
  tablesplit=$tablesplit", "$splitpos
done
tablesplit=$tablesplit");"

echo "
CREATE TABLE counttable (
    id BIGINT NOT NULL,
    link_type BIGINT NOT NULL,
    count BIGINT NOT NULL,
    time BIGINT NOT NULL,
    version BIGINT NOT NULL
    CONSTRAINT pk PRIMARY KEY (id, link_type)
    )
    COMPRESSION='LZO'" >> $sqlfile
echo "    "$tablesplit >> $sqlfile


